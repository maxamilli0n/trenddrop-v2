name: trenddrop-cron

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 * * * *"   # hourly

permissions:
  contents: write

concurrency:
  group: trenddrop-docs-main
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      EBAY_CLIENT_ID:         ${{ secrets.EBAY_CLIENT_ID }}
      EBAY_CLIENT_SECRET:     ${{ secrets.EBAY_CLIENT_SECRET }}
      EBAY_APP_ID:            ${{ secrets.EBAY_APP_ID }}
      EPN_CAMPAIGN_ID:        ${{ secrets.EPN_CAMPAIGN_ID }}

      SUPABASE_URL:           ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY:      ${{ secrets.SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      OPENAI_API_KEY:         ${{ secrets.OPENAI_API_KEY }}

      TELEGRAM_BOT_TOKEN:        ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_PUBLIC_CHANNEL_ID: ${{ secrets.TELEGRAM_PUBLIC_CHANNEL_ID }}
      TELEGRAM_PAID_CHANNEL_ID:   ${{ secrets.TELEGRAM_PAID_CHANNEL_ID }}
      TELEGRAM_ADMIN_CHAT_ID:     ${{ secrets.TELEGRAM_ADMIN_CHAT_ID }}

      TELEGRAM_CHAT_ID:          ${{ secrets.TELEGRAM_CHAT_ID }}
      TELEGRAM_CHANNEL_ID:       ${{ secrets.TELEGRAM_CHANNEL_ID }}

      GUMROAD_CTA_URL:          ${{ secrets.GUMROAD_CTA_URL }}
      CLICK_REDIRECT_BASE:      ${{ secrets.CLICK_REDIRECT_BASE }}

      TELEGRAM_CTA_COOLDOWN_MINUTES: ${{ vars.TELEGRAM_CTA_COOLDOWN_MINUTES }}
      TELEGRAM_CTA_EVERY_N_POSTS:    ${{ vars.TELEGRAM_CTA_EVERY_N_POSTS }}
      TELEGRAM_PIN_CTA:              ${{ vars.TELEGRAM_PIN_CTA }}

      TREND_TOPICS_LIMIT:     ${{ vars.TREND_TOPICS_LIMIT }}
      TREND_PER_PAGE:         ${{ vars.TREND_PER_PAGE }}
      TREND_SLEEP_SECS:       ${{ vars.TREND_SLEEP_SECS }}
      TREND_SLEEP_JITTER:     ${{ vars.TREND_SLEEP_JITTER }}
      TREND_PICKS_LIMIT:      ${{ vars.TREND_PICKS_LIMIT }}
      TREND_TELEGRAM_LIMIT:   ${{ vars.TREND_TELEGRAM_LIMIT }}

      EBAY_CACHE_TTL_MIN:     ${{ vars.EBAY_CACHE_TTL_MIN }}
      EBAY_CACHE_BYPASS:      ${{ vars.EBAY_CACHE_BYPASS }}
      DEBUG_EBAY:             ${{ vars.DEBUG_EBAY }}

      TELEGRAM_POST_SCOPE:    ${{ vars.TELEGRAM_POST_SCOPE }}
      PYTHONPATH: ${{ github.workspace }}

    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt

      - name: Restore .env from GitHub Secret (optional)
        shell: bash
        run: |
          if [ -n "${{ secrets.ENV_FILE }}" ]; then
            cat << 'EOF' > .env
          ${{ secrets.ENV_FILE }}
          EOF
            echo "[env] .env restored"
          else
            echo "[env] ENV_FILE secret not set; skipping"
          fi

      - name: Run scraper + publish
        run: python trenddrop_cli.py scrape-ebay

      - name: Commit & push docs updates safely (rebase + lease + retry)
        shell: bash
        run: |
          set -euo pipefail

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Always rebase onto latest main FIRST
          git fetch origin main
          git rebase origin/main

          git add docs/data/products.json docs/og.png || true

          if [ -z "$(git status --porcelain)" ]; then
            echo "[git] No changes to commit."
            exit 0
          fi

          git commit -m "Update products.json [skip ci]" || true

          for i in 1 2 3 4 5; do
            if git push --force-with-lease origin HEAD:main; then
              echo "[git] Push succeeded."
              exit 0
            fi
            echo "[git] Push failed (attempt $i). Rebase and retry..."
            sleep $((i * 3))
            git fetch origin main
            git rebase origin/main || true
          done

          echo "[git] Push failed after retries."
          exit 1
