# TD-AUTO: BEGIN publish-products
name: Publish TrendDrop Products
on:
  workflow_dispatch:
    workflows: ["Generate Weekly"]
    types: [completed]
jobs:
  td_auto_publish:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Build manifest
        run: python -m trenddrop.reports.build_manifest
      - name: Sync Stripe
        env:
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_PRODUCT_ID: ${{ secrets.STRIPE_PRODUCT_ID }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: python -m trenddrop.storefront.sync_stripe
      - name: Sync Gumroad
        env:
          GUMROAD_ACCESS_TOKEN: ${{ secrets.GUMROAD_ACCESS_TOKEN }}
          GUMROAD_PRODUCT_ID: ${{ secrets.GUMROAD_PRODUCT_ID }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: python -m trenddrop.storefront.sync_gumroad
      - name: Sync Payhip
        env:
          PAYHIP_API_KEY: ${{ secrets.PAYHIP_API_KEY }}
          PAYHIP_PRODUCT_ID: ${{ secrets.PAYHIP_PRODUCT_ID }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: python -m trenddrop.storefront.sync_payhip
      - name: Telegram announce
        if: ${{ success() }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python - << 'PY'
          from trenddrop.telegram_utils import send_text
          text = (
              "\ud83c\udd95 New Weekly Pack is live!\n"
              "\ud83d\udce6 TrendDrop Weekly Pack\n"
              "\ud83d\udcb0 Available on Stripe / Gumroad / Payhip\n"
          )
          try:
              send_text(text)
          except Exception as e:
              print(f"[publish-products] telegram failed: {e}")
          PY
# TD-AUTO: END publish-products


